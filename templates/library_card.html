<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Library Card | Library Management System</title>
<style>
/* GLOBAL */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #ffffff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
}

/* MOBILE MENU BUTTON */
.mobile-menu-btn {
    display: none;
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1001;
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    cursor: pointer;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all 0.3s ease;
}

.mobile-menu-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.mobile-menu-btn span {
    width: 20px;
    height: 2px;
    background: white;
    transition: all 0.3s ease;
}

.mobile-menu-btn.active span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
}

.mobile-menu-btn.active span:nth-child(2) {
    opacity: 0;
}

.mobile-menu-btn.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -7px);
}

/* SIDEBAR */
.sidebar {
    width: 280px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-right: 1px solid rgba(255, 255, 255, 0.2);
    padding: 30px 20px;
    transition: width 0.3s ease, transform 0.3s ease;
    position: fixed;
    left: 0;
    top: 0;
    height: 100vh;
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 1000;
}

.sidebar.collapsed {
    width: 80px;
}

.sidebar.collapsed .logo-text,
.sidebar.collapsed .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
}

.sidebar.collapsed .logo {
    justify-content: center;
}

.toggle-btn {
    position: absolute;
    top: 20px;
    right: -15px;
    width: 30px;
    height: 30px;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.3s ease;
    z-index: 10;
}

.toggle-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.logo {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 40px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: #fff;
}

.logo-icon {
    font-size: 32px;
    min-width: 32px;
}

.logo-text {
    transition: opacity 0.3s ease;
    white-space: nowrap;
}

.menu {
    list-style: none;
}

.menu li {
    margin: 8px 0;
}

.menu a {
    text-decoration: none;
    color: rgba(255, 255, 255, 0.8);
    font-size: 16px;
    padding: 12px 15px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
}

.menu a:hover {
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
    transform: translateX(5px);
}

.menu-icon {
    font-size: 20px;
    min-width: 20px;
}

.menu-text {
    transition: opacity 0.3s ease;
    white-space: nowrap;
}

.active {
    background: rgba(255, 255, 255, 0.2) !important;
    color: #fff !important;
    font-weight: 600;
}

/* MAIN CONTENT */
.main {
    margin-left: 280px;
    padding: 40px;
    min-height: 100vh;
    background: rgba(0, 0, 0, 0.1);
    transition: margin-left 0.3s ease;
}

.sidebar.collapsed + .main {
    margin-left: 80px;
}

/* FLASH MESSAGES */
.flash {
    padding: 15px 20px;
    margin-bottom: 20px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.success { background: rgba(46, 213, 115, 0.3); }
.error { background: rgba(255, 71, 87, 0.3); }
.info { background: rgba(0, 168, 255, 0.3); }

/* CARD CONTAINER */
.card-container {
    display: flex;
    gap: 40px;
    flex-wrap: wrap;
}

/* LIBRARY CARD DESIGN */
.library-card-section {
    flex: 1;
    min-width: 300px;
}

.card-header {
    margin-bottom: 30px;
}

.card-header h2 {
    font-size: 32px;
    margin-bottom: 10px;
    background: linear-gradient(to right, #fff, #f0f0f0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.card-header p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 16px;
}

/* PHYSICAL CARD STYLING */
.library-card {
    background: linear-gradient(145deg, #4f46e5, #7c3aed);
    padding: 40px;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
    border: 2px solid rgba(255, 255, 255, 0.2);
    max-width: 500px;
    transition: all 0.3s ease;
}

.library-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
}

.card-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.1;
    background: radial-gradient(circle at 30% 20%, #ffffff 0%, transparent 50%);
}

.card-logo {
    font-size: 48px;
    margin-bottom: 30px;
    text-align: center;
}

.card-title {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
    color: white;
    text-align: center;
}

.card-holder-name {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    text-align: center;
}

.card-details {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.detail-label {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
}

.detail-value {
    font-weight: 700;
    color: white;
    font-size: 16px;
}

.card-number {
    background: rgba(255, 255, 255, 0.1);
    padding: 10px 20px;
    border-radius: 10px;
    font-family: monospace;
    letter-spacing: 2px;
    text-align: center;
    margin: 20px 0;
    font-size: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.card-footer {
    margin-top: 30px;
    text-align: center;
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* STATS SECTION */
.stats-section {
    flex: 1;
    min-width: 300px;
}

.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    padding: 25px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}

.stat-card:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-5px);
}

.stat-value {
    font-size: 36px;
    font-weight: bold;
    margin-bottom: 10px;
    background: linear-gradient(to right, #fff, #f0f0f0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
}

/* ACTION BUTTONS */
.actions-section {
    margin-top: 40px;
}

.actions-section h3 {
    margin-bottom: 20px;
    font-size: 22px;
}

.action-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 15px;
}

.btn-primary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-primary:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.btn-secondary {
    background: rgba(79, 70, 229, 0.3);
    color: white;
    border: 1px solid rgba(79, 70, 229, 0.5);
}

.btn-secondary:hover {
    background: rgba(79, 70, 229, 0.4);
    transform: translateY(-2px);
}

.btn-icon {
    font-size: 18px;
}

/* LOADING SPINNER */
.spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 4px solid white;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* REQUEST FORM */
.request-form {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 12px;
    margin-top: 20px;
    display: none;
}

.request-form textarea {
    width: 100%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    padding: 12px;
    color: white;
    font-family: inherit;
    margin-bottom: 15px;
    resize: vertical;
}

.request-form textarea::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.form-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* QR CODE */
.qr-section {
    margin-top: 40px;
    text-align: center;
}

.qr-container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    display: inline-block;
    margin-top: 15px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.qr-container:hover {
    transform: scale(1.05);
}

.qr-placeholder {
    width: 200px;
    height: 200px;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    color: #333;
    font-weight: bold;
}

/* QR MODAL */
.qr-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.qr-modal-content {
    text-align: center;
    padding: 20px;
}

.qr-modal img {
    max-width: 80%;
    max-height: 80%;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.qr-modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 24px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
}

/* FOOTER */
footer {
    text-align: center;
    padding: 25px;
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
    margin-top: 50px;
}

/* MOBILE OVERLAY */
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

.sidebar-overlay.active {
    display: block;
}

/* RESPONSIVE */
@media (max-width: 1024px) {
    .card-container {
        flex-direction: column;
    }
    
    .library-card {
        max-width: 100%;
    }
}

@media (max-width: 768px) {
    .mobile-menu-btn {
        display: flex;
    }
    
    .sidebar {
        transform: translateX(-100%);
        width: 280px;
    }
    
    .sidebar.open {
        transform: translateX(0);
    }
    
    .sidebar .toggle-btn {
        display: none;
    }
    
    .main {
        margin-left: 0 !important;
        padding: 80px 20px 20px 20px;
        width: 100%;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
}

/* PRINT STYLES */
@media print {
    body {
        background: white !important;
        color: black !important;
    }
    
    .sidebar, .mobile-menu-btn, .actions-section, .qr-section, footer {
        display: none !important;
    }
    
    .main {
        margin-left: 0 !important;
        padding: 0 !important;
    }
    
    .library-card {
        box-shadow: none !important;
        border: 2px solid #000 !important;
        color: black !important;
        background: white !important;
    }
    
    .library-card * {
        color: black !important;
    }
}
</style>
</head>
<body>

<!-- Mobile Menu Button -->
<div class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">
    <span></span>
    <span></span>
    <span></span>
</div>

<!-- Sidebar Overlay for Mobile -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
    <div class="toggle-btn" onclick="toggleSidebar()">‚óÄ</div>
    
    <div class="logo">
        <span class="logo-icon">üìö</span>
        <span class="logo-text">Library</span>
    </div>

    <ul class="menu">
        <li>
            <a href="{{ url_for('index') }}">
                <span class="menu-icon">üè†</span>
                <span class="menu-text">Home</span>
            </a>
        </li>
        <li>
            <a href="{{ url_for('books') }}">
                <span class="menu-icon">üìñ</span>
                <span class="menu-text">All Books</span>
            </a>
        </li>
        <li>
            <a href="{{ url_for('search') }}">
                <span class="menu-icon">üîç</span>
                <span class="menu-text">Search</span>
            </a>
        </li>
        
        {% if session.get('user_id') %}
            <li>
                <a href="{{ url_for('add_book') }}">
                    <span class="menu-icon">‚ûï</span>
                    <span class="menu-text">Add Book</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('edit_book', book_id=1) }}">
                    <span class="menu-icon">‚úèÔ∏è</span>
                    <span class="menu-text">Edit Book</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('library_card') }}" class="active">
                    <span class="menu-icon">üí≥</span>
                    <span class="menu-text">Library Card</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('logout') }}">
                    <span class="menu-icon">üö™</span>
                    <span class="menu-text">Logout</span>
                </a>
            </li>
        {% else %}
            <li>
                <a href="{{ url_for('login') }}">
                    <span class="menu-icon">üîê</span>
                    <span class="menu-text">Login</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('register') }}">
                    <span class="menu-icon">üìù</span>
                    <span class="menu-text">Register</span>
                </a>
            </li>
        {% endif %}
    </ul>
</aside>

<!-- MAIN CONTENT -->
<main class="main">

    <!-- FLASH MESSAGES -->
    {% with msgs = get_flashed_messages(with_categories=true) %}
        {% for cat, msg in msgs %}
            <div class="flash {{ cat }}">{{ msg }}</div>
        {% endfor %}
    {% endwith %}

    <!-- LIBRARY CARD SECTION -->
    <div class="card-container">
        <!-- Left Column: Card Display -->
        <div class="library-card-section">
            <div class="card-header">
                <h2>Your Digital Library Card</h2>
                <p>Your personal access to our library resources and services</p>
            </div>
            
            <div class="library-card">
                <div class="card-background"></div>
                <div class="card-logo">üìö</div>
                <h3 class="card-title">LIBRARY MEMBERSHIP CARD</h3>
                
                <div class="card-holder-name">{{ session.get('username') }}</div>
                
                <div class="card-number">{{ card['card_number'] }}</div>
                
                <div class="card-details">
                    <div class="detail-row">
                        <span class="detail-label">Card Holder</span>
                        <span class="detail-value">{{ session.get('username') }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Member Since</span>
                        <span class="detail-value">{{ card['issue_date'] }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Valid Until</span>
                        <span class="detail-value" id="validUntil">{{ valid_until }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Member ID</span>
                        <span class="detail-value">LIB{{ "%06d"|format(session.get('user_id')) }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Card Status</span>
                        <span class="detail-value" id="cardStatus">Active</span>
                    </div>
                </div>
                
                <div class="card-footer">
                    <p>This card must be presented at the library desk for all services</p>
                    <p>üìç Main Library Branch ‚Ä¢ üìû (555) 123-4567</p>
                </div>
            </div>
        </div>

        <!-- Right Column: Stats & Actions -->
        <div class="stats-section">
            <!-- Statistics -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="booksBorrowed">0</div>
                    <div class="stat-label">Books Borrowed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeReservations">0</div>
                    <div class="stat-label">Active Reservations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="finesDue">‚Çπ0</div>
                    <div class="stat-label">Fines Due</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="readingStreak">0</div>
                    <div class="stat-label">Day Reading Streak</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="actions-section">
                <h3>Card Actions</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="printCard()">
                        <span class="btn-icon">üñ®Ô∏è</span> Print Card
                    </button>
                    <button class="btn btn-secondary" onclick="downloadPDF()">
                        <span class="btn-icon">üíæ</span> Download PDF
                    </button>
                    <button class="btn btn-primary" onclick="shareCard()">
                        <span class="btn-icon">üì≤</span> Share Card
                    </button>
                    <button class="btn btn-secondary" onclick="showRequestForm()">
                        <span class="btn-icon">üîÑ</span> Request New Card
                    </button>
                </div>
                
                <!-- Request Card Form -->
                <div id="requestForm" class="request-form">
                    <textarea id="requestReason" placeholder="Reason for requesting new card (e.g., lost, damaged, name change, etc.)" rows="3"></textarea>
                    <div class="form-buttons">
                        <button class="btn btn-primary" onclick="submitRequest()">Submit Request</button>
                        <button class="btn btn-secondary" onclick="hideRequestForm()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- QR Code for Digital Card -->
            <div class="qr-section">
                <h3>Digital Card QR Code</h3>
                <p>Scan to view digital card on mobile</p>
                <div class="qr-container" onclick="openQRModal()">
                    <div id="qrCodeImage" class="qr-placeholder">
                        <div class="spinner" id="qrSpinner"></div>
                        <span id="qrText" style="display: none;">Loading QR Code...</span>
                    </div>
                </div>
                <p style="font-size: 12px; margin-top: 10px; color: rgba(255,255,255,0.7)">
                    Click QR code to enlarge ‚Ä¢ Scan at library terminals
                </p>
            </div>
            
            <!-- Card Information -->
            <div style="margin-top: 30px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px;">
                <h4 style="margin-bottom: 15px;">üìã Card Information</h4>
                <div style="font-size: 14px; color: rgba(255,255,255,0.8); line-height: 1.6;">
                    <p>‚Ä¢ This card is valid for 2 years from issue date</p>
                    <p>‚Ä¢ Report lost cards immediately to prevent misuse</p>
                    <p>‚Ä¢ Maximum 5 books can be borrowed at once</p>
                    <p>‚Ä¢ Renewals allowed up to 3 times per book</p>
                    <p>‚Ä¢ Late returns incur fines of ‚Çπ10 per day</p>
                </div>
            </div>
        </div>
    </div>

</main>

<!-- QR Code Modal -->
<div id="qrModal" class="qr-modal">
    <button class="qr-modal-close" onclick="closeQRModal()">√ó</button>
    <div class="qr-modal-content">
        <div id="qrModalImage"></div>
        <p style="color: white; margin-top: 20px;">Scan this QR code with your phone camera</p>
    </div>
</div>

<footer>
    ¬© 2025 Library Management System | Made with ‚ù§Ô∏è
</footer>

<script>
// Sidebar Functions
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.querySelector('.toggle-btn');
    
    sidebar.classList.toggle('collapsed');
    
    if (sidebar.classList.contains('collapsed')) {
        toggleBtn.innerHTML = '‚ñ∂';
    } else {
        toggleBtn.innerHTML = '‚óÄ';
    }
}

function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const menuBtn = document.getElementById('mobileMenuBtn');
    
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
    menuBtn.classList.toggle('active');
}

function closeMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const menuBtn = document.getElementById('mobileMenuBtn');
    
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    menuBtn.classList.remove('active');
}

// Close mobile menu when clicking a link
document.querySelectorAll('.menu a').forEach(link => {
    link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            closeMobileMenu();
        }
    });
});

// Handle window resize
window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const menuBtn = document.getElementById('mobileMenuBtn');
        
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        menuBtn.classList.remove('active');
    }
});

// -------------------- LIBRARY CARD FUNCTIONS --------------------

// Load user statistics from backend
async function loadUserStats() {
    try {
        const userId = {{ session.get('user_id') }};
        const response = await fetch(`/card_stats/${userId}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Error loading stats:', data.error);
            showFallbackStats();
            return;
        }
        
        // Update statistics
        document.getElementById('booksBorrowed').textContent = data.books_borrowed;
        document.getElementById('activeReservations').textContent = data.active_reservations;
        document.getElementById('finesDue').textContent = data.fines_due > 0 ? `‚Çπ${data.fines_due}` : '‚Çπ0';
        document.getElementById('readingStreak').textContent = data.reading_streak;
        
        // Update validity if available
        if (data.valid_until) {
            document.getElementById('validUntil').textContent = data.valid_until;
        }
        
    } catch (error) {
        console.error('Error loading stats:', error);
        showFallbackStats();
    }
}

// Show fallback statistics if API fails
function showFallbackStats() {
    // Generate random stats for demonstration
    const randomStats = {
        booksBorrowed: Math.floor(Math.random() * 20),
        activeReservations: Math.floor(Math.random() * 5),
        finesDue: Math.random() > 0.7 ? Math.floor(Math.random() * 200) : 0,
        readingStreak: Math.floor(Math.random() * 30)
    };
    
    document.getElementById('booksBorrowed').textContent = randomStats.booksBorrowed;
    document.getElementById('activeReservations').textContent = randomStats.activeReservations;
    document.getElementById('finesDue').textContent = randomStats.finesDue > 0 ? `‚Çπ${randomStats.finesDue}` : '‚Çπ0';
    document.getElementById('readingStreak').textContent = randomStats.readingStreak;
}

// Generate and display QR code - FIXED VERSION
async function loadQRCode() {
    const qrContainer = document.getElementById('qrCodeImage');
    const qrSpinner = document.getElementById('qrSpinner');
    const qrText = document.getElementById('qrText');
    
    try {
        const userId = {{ session.get('user_id') }};
        console.log('Loading QR code for user ID:', userId);
        
        const response = await fetch(`/generate_qr/${userId}`);
        
        if (!response.ok) {
            // Check if it's a JSON error or HTML error
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Server error: ${response.status}`);
            } else {
                // If not JSON, get text and try to parse as JSON
                const errorText = await response.text();
                console.error('Non-JSON error response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Create and display QR code image
        const img = document.createElement('img');
        img.src = data.qr_code;
        img.alt = "Library Card QR Code";
        img.style.width = '200px';
        img.style.height = '200px';
        img.style.borderRadius = '8px';
        
        // Store QR code data for modal
        img.dataset.qrCode = data.qr_code;
        
        // Replace spinner with QR code
        qrContainer.innerHTML = '';
        qrContainer.appendChild(img);
        if (qrSpinner) qrSpinner.style.display = 'none';
        if (qrText) qrText.style.display = 'none';
        
        console.log('QR code loaded successfully');
        
    } catch (error) {
        console.error('Error loading QR code:', error);
        
        // Fallback: Create a text-based display
        qrContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #333;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìá</div>
                <div style="font-family: monospace; font-size: 11px; line-height: 1.4;">
                    <strong>LIBRARY CARD</strong><br>
                    Card: {{ card['card_number'] }}<br>
                    Name: {{ session.get('username') }}<br>
                    ID: LIB{{ "%06d"|format(session.get('user_id')) }}<br>
                    Issued: {{ card['issue_date'] }}
                </div>
                <div style="margin-top: 10px; font-size: 10px; color: #666;">
                    QR Code Error: ${error.message}
                </div>
            </div>
        `;
        if (qrSpinner) qrSpinner.style.display = 'none';
        if (qrText) qrText.style.display = 'none';
    }
}

// QR Code Modal Functions
function openQRModal() {
    const qrModal = document.getElementById('qrModal');
    const qrModalImage = document.getElementById('qrModalImage');
    
    // Get the QR code image from the container
    const qrImg = document.querySelector('#qrCodeImage img');
    
    if (qrImg && qrImg.src) {
        // Clone the image for modal
        const modalImg = qrImg.cloneNode(true);
        modalImg.style.maxWidth = '300px';
        modalImg.style.maxHeight = '300px';
        
        qrModalImage.innerHTML = '';
        qrModalImage.appendChild(modalImg);
        qrModal.style.display = 'flex';
    } else {
        // Create fallback QR display
        qrModalImage.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                <div style="font-size: 72px; margin-bottom: 20px;">üìá</div>
                <div style="font-family: monospace; font-size: 14px; color: #333;">
                    <strong>LIBRARY CARD</strong><br><br>
                    Card: {{ card['card_number'] }}<br>
                    Name: {{ session.get('username') }}<br>
                    ID: LIB{{ "%06d"|format(session.get('user_id')) }}<br>
                    Issued: {{ card['issue_date'] }}<br>
                    Valid Until: {{ valid_until }}
                </div>
            </div>
        `;
        qrModal.style.display = 'flex';
    }
}

function closeQRModal() {
    document.getElementById('qrModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('qrModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeQRModal();
    }
});

// Card Actions
function printCard() {
    // Highlight card before printing
    const card = document.querySelector('.library-card');
    const originalTransform = card.style.transform;
    const originalBoxShadow = card.style.boxShadow;
    
    card.style.transform = 'scale(1.02)';
    card.style.boxShadow = '0 0 40px rgba(255,255,255,0.4)';
    
    setTimeout(() => {
        card.style.transform = originalTransform;
        card.style.boxShadow = originalBoxShadow;
        window.print();
    }, 300);
}

function downloadPDF() {
    // Show loading state
    const btn = event.target.closest('.btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="btn-icon">‚è≥</span> Generating PDF...';
    btn.disabled = true;
    
    // Redirect to PDF download endpoint
    const userId = {{ session.get('user_id') }};
    window.location.href = `/download_card_pdf/${userId}`;
    
    // Reset button after 3 seconds
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 3000);
}

function shareCard() {
    const cardData = {
        title: 'My Library Card - {{ session.get("username") }}',
        text: `üìö Library Card Details:\n\n` +
              `Name: {{ session.get('username') }}\n` +
              `Card Number: {{ card['card_number'] }}\n` +
              `Member ID: LIB{{ "%06d"|format(session.get('user_id')) }}\n` +
              `Issue Date: {{ card['issue_date'] }}\n` +
              `Valid Until: {{ valid_until }}\n\n` +
              `Issued by Library Management System`,
        url: window.location.href,
    };
    
    if (navigator.share) {
        navigator.share(cardData)
            .then(() => console.log('Card shared successfully'))
            .catch(err => console.log('Error sharing:', err));
    } else {
        // Fallback: Copy to clipboard
        const textToCopy = cardData.text + `\n\nView online: ${cardData.url}`;
        
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                alert('‚úÖ Card details copied to clipboard!');
            })
            .catch(err => {
                // Fallback to prompt
                prompt('üìã Copy this text to share:', textToCopy);
            });
    }
}

function showRequestForm() {
    document.getElementById('requestForm').style.display = 'block';
    event.target.style.display = 'none';
}

function hideRequestForm() {
    document.getElementById('requestForm').style.display = 'none';
    document.querySelector('.btn-secondary').style.display = 'flex';
}

async function submitRequest() {
    const reason = document.getElementById('requestReason').value.trim();
    
    if (!reason) {
        alert('‚ö†Ô∏è Please provide a reason for requesting a new card.');
        return;
    }
    
    if (reason.length < 10) {
        alert('‚ö†Ô∏è Please provide a more detailed reason (at least 10 characters).');
        return;
    }
    
    // Show loading state
    const form = document.getElementById('requestForm');
    const submitBtn = form.querySelector('.btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Submitting...';
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('reason', reason);
        
        const response = await fetch('/request_new_card', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ ' + (data.message || 'Request submitted successfully!\nYou will be notified when your new card is ready.'));
            hideRequestForm();
            document.getElementById('requestReason').value = '';
        } else {
            alert('‚ùå ' + (data.error || 'Failed to submit request. Please try again.'));
        }
    } catch (error) {
        console.error('Error submitting request:', error);
        alert('‚ùå Error submitting request. Please check your connection and try again.');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// Check card validity
function checkCardValidity() {
    const validUntil = document.getElementById('validUntil').textContent;
    const today = new Date();
    
    if (validUntil !== 'Permanent') {
        const expiryDate = new Date(validUntil);
        
        // Calculate days until expiry
        const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        const cardStatus = document.getElementById('cardStatus');
        
        if (expiryDate < today) {
            cardStatus.textContent = 'Expired';
            cardStatus.style.color = '#ff6b6b';
            
            // Show warning
            const warning = document.createElement('div');
            warning.className = 'flash error';
            warning.innerHTML = '‚ö†Ô∏è Your library card has expired. Please visit the library desk for renewal.';
            document.querySelector('.card-header').appendChild(warning);
        } else if (daysUntilExpiry <= 30) {
            cardStatus.textContent = `Expires in ${daysUntilExpiry} days`;
            cardStatus.style.color = '#ffd166';
            
            // Show warning if less than 7 days
            if (daysUntilExpiry <= 7) {
                const warning = document.createElement('div');
                warning.className = 'flash info';
                warning.innerHTML = `‚ö†Ô∏è Your library card expires in ${daysUntilExpiry} days. Renew soon!`;
                document.querySelector('.card-header').appendChild(warning);
            }
        }
    }
}

// -------------------- INITIALIZATION --------------------
document.addEventListener('DOMContentLoaded', function() {
    // Load data from backend
    loadUserStats();
    loadQRCode();
    
    // Check card validity
    setTimeout(checkCardValidity, 1000);
    
    // Add animation to card
    const card = document.querySelector('.library-card');
    setTimeout(() => {
        card.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            card.style.transform = 'translateY(0)';
        }, 200);
    }, 300);
    
    // Add hover effect
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-15px) rotateY(5deg)';
        this.style.boxShadow = '0 25px 80px rgba(0, 0, 0, 0.4)';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0) rotateY(0)';
        this.style.boxShadow = '0 20px 60px rgba(0, 0, 0, 0.3)';
    });
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+P to print
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            printCard();
        }
        // Escape to close QR modal
        if (e.key === 'Escape') {
            closeQRModal();
        }
    });
    
    // Auto-hide flash messages after 5 seconds
    setTimeout(() => {
        document.querySelectorAll('.flash').forEach(flash => {
            flash.style.opacity = '0';
            flash.style.transition = 'opacity 0.5s ease';
            setTimeout(() => flash.remove(), 500);
        });
    }, 5000);
    
    // Add click handler to QR container
    document.querySelector('.qr-container').addEventListener('click', openQRModal);
});
</script>

</body>
</html>
