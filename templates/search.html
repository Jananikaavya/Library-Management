<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Search Books - Library</title>
  <style>
    /* GLOBAL */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
         background: linear-gradient(135deg, #092394 0%, #3d0a70 100%);
        color: #ffffff;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
    }

    .dashboard {
        display: flex;
        min-height: 100vh;
    }

    /* MOBILE MENU BUTTON */
    .mobile-menu-btn {
        display: none;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1001;
        width: 45px;
        height: 45px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        cursor: pointer;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 5px;
        transition: all 0.3s ease;
    }

    .mobile-menu-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .mobile-menu-btn span {
        width: 20px;
        height: 2px;
        background: white;
        transition: all 0.3s ease;
    }

    .mobile-menu-btn.active span:nth-child(1) {
        transform: rotate(45deg) translate(5px, 5px);
    }

    .mobile-menu-btn.active span:nth-child(2) {
        opacity: 0;
    }

    .mobile-menu-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translate(7px, -7px);
    }

    /* SIDEBAR */
    .sidebar {
        width: 280px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(15px);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        padding: 30px 20px;
        transition: width 0.3s ease, transform 0.3s ease;
        position: relative;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .sidebar.collapsed {
        width: 80px;
    }

    .sidebar.collapsed .logo-text,
    .sidebar.collapsed .menu-text {
        opacity: 0;
        width: 0;
        overflow: hidden;
    }

    .sidebar.collapsed .logo {
        justify-content: center;
    }

    .toggle-btn {
        position: absolute;
        top: 20px;
        right: -15px;
        width: 30px;
        height: 30px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.3s ease;
        z-index: 10;
    }

    .toggle-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .logo {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: #fff;
    }

    .logo-icon {
        font-size: 32px;
        min-width: 32px;
    }

    .logo-text {
        transition: opacity 0.3s ease;
        white-space: nowrap;
    }

    .menu {
        list-style: none;
    }

    .menu li {
        margin: 8px 0;
    }

    .menu a {
        text-decoration: none;
        color: rgba(255, 255, 255, 0.8);
        font-size: 16px;
        padding: 12px 15px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.3s ease;
    }

    .menu a:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        transform: translateX(5px);
    }

    .menu-icon {
        font-size: 20px;
        min-width: 20px;
    }

    .menu-text {
        transition: opacity 0.3s ease;
        white-space: nowrap;
    }

    .active {
        background: rgba(255, 255, 255, 0.2) !important;
        color: #fff !important;
        font-weight: 600;
    }

    /* MAIN */
    .main {
        flex: 1;
        padding: 40px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.1);
    }

    /* FLASH */
    .flash {
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 12px;
        
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .success { background: rgba(46, 213, 115, 0.3); }
    .error { background: rgba(255, 71, 87, 0.3); }
    .info { background: rgba(0, 168, 255, 0.3); }

    /* SEARCH FORM STYLES */
    .container {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 40px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        max-width: 1000px;
        margin: 0 auto;
    }

    .container h2 {
        font-size: 32px;
        margin-bottom: 30px;
        background: linear-gradient(to right, #fff, #f0f0f0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-align: center;
    }

    /* Search Form */
    .search-form {
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        flex: 1;
    }

    label {
        display: block;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
    }

    input, select {
        width: 100%;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
       
        font-size: 16px;
        transition: all 0.3s ease;
    }

    input:focus, select:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.5);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    }

    input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .form-actions {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    /* BUTTONS */
    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
       
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    /* FIX 1: Added missing btn-tertiary style */
    .btn-tertiary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-tertiary:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    /* TABLE STYLES */
    .table-wrap {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 30px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }

    thead {
        background: rgba(255, 255, 255, 0.2);
    }

    th {
        padding: 15px;
        text-align: left;
        color: white;
        font-weight: 600;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    }

    td {
        padding: 12px 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
    }

    tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    /* STATUS BADGES */
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        display: inline-block;
    }

    .status-available {
        background: rgba(46, 213, 115, 0.3);
        color: #2ed573;
    }

    .status-unavailable {
        background: rgba(255, 71, 87, 0.3);
        color: #ff4757;
    }

    /* NO RESULTS MESSAGE */
    .no-results {
        text-align: center;
        padding: 40px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 18px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 30px;
    }

    /* RESULTS HEADER */
    .results-header {
        font-size: 24px;
        margin: 30px 0 15px 0;
        color: white;
        text-align: center;
    }

    /* FOOTER */
    footer {
        text-align: center;
        padding: 25px;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
    }

    /* MOBILE OVERLAY */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    .sidebar-overlay.active {
        display: block;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
        .mobile-menu-btn {
            display: flex;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 1000;
            transform: translateX(-100%);
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar .toggle-btn {
            display: none;
        }
        
        .main {
            padding: 80px 20px 20px 20px;
            width: 100%;
        }
        
        .container {
            padding: 20px;
            margin: 0;
        }
        
        .container h2 {
            font-size: 24px;
        }
        
        .search-form {
            padding: 20px;
        }
        
        .form-row {
            flex-direction: column;
            gap: 15px;
        }
        
        .btn {
            width: 100%;
        }
        
        .table-wrap {
            margin: 0 -10px;
        }
        
        td, th {
            padding: 8px 10px;
        }
        
        .results-header {
            font-size: 20px;
        }
    }

    /* TABLET */
    @media (min-width: 769px) and (max-width: 1024px) {
        .sidebar {
            width: 240px;
        }
        
        .main {
            padding: 30px;
        }
        
        .container {
            padding: 25px;
        }
        
        .container h2 {
            font-size: 28px;
        }
    }

    /* Additional Styles for New Features */
    
    /* Advanced Search Toggle */
    .advanced-toggle {
        text-align: center;
        margin: 15px 0;
    }
    
    .advanced-toggle-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        margin: 0 auto;
    }
    
    .advanced-toggle-btn:hover {
        color: white;
    }
    
    .advanced-toggle-btn i {
        transition: transform 0.3s ease;
    }
    
    .advanced-toggle-btn.active i {
        transform: rotate(180deg);
    }
    
    /* Advanced Search Panel */
    .advanced-search {
        background: rgba(255, 255, 255, 0.08);
        padding: 20px;
        border-radius: 10px;
        margin-top: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: none;
    }
    
    .advanced-search.show {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Filter Section */
    .filters-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .filter-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .filter-group {
        flex: 1;
        min-width: 150px;
    }
    
    .filter-label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 5px;
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* Sort Options */
    .sort-options {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 15px 0;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }
    
    .sort-label {
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
    }
    
    /* Quick Search Buttons */
    .quick-search {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .quick-btn {
        padding: 8px 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        color: white;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .quick-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }
    
    /* Export Options */
    .export-options {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
    }
    
    .export-btn {
        padding: 8px 15px;
        background: rgba(46, 204, 113, 0.2);
        border: 1px solid rgba(46, 204, 113, 0.3);
        border-radius: 6px;
        color: #2ecc71;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
    }
    
    .export-btn:hover {
        background: rgba(46, 204, 113, 0.3);
    }
    
    /* Book Preview Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        backdrop-filter: blur(5px);
    }
    
    .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }
    
    .modal {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .modal-title {
        font-size: 24px;
        color: white;
    }
    
    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
    }
    
    .modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    .book-details {
        display: grid;
        gap: 15px;
    }
    
    .detail-row {
        display: flex;
        gap: 20px;
    }
    
    .detail-label {
        color: rgba(255, 255, 255, 0.7);
        min-width: 120px;
    }
    
    .detail-value {
        color: white;
        font-weight: 500;
    }
    
    /* View Toggle */
    .view-toggle {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 15px;
        gap: 5px;
    }
    
    .view-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: white;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .view-btn.active {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .view-btn:hover {
        background: rgba(255, 255, 255, 0.15);
    }
    
    /* Grid View */
    .grid-view {
        display: none;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .grid-view.active {
        display: grid;
    }
    
    .book-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .book-card:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .book-card-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 5px;
        color: white;
    }
    
    .book-card-author {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 10px;
    }
    
    .book-card-details {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        display: flex;
        justify-content: space-between;
    }
    
    /* Stats Panel */
    .stats-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        margin: 20px 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .stat-item {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: white;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 30px;
        padding: 20px;
    }
    
    .page-btn {
        padding: 8px 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .page-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .page-btn:hover:not(.active) {
        background: rgba(255, 255, 255, 0.2);
    }
    
    /* Loading Animation */
    .loading {
        display: none;
        text-align: center;
        padding: 30px;
    }
    
    .loading.active {
        display: block;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Clear Filters Button */
    .clear-filters {
        text-align: center;
        margin-top: 15px;
    }
    
    .clear-btn {
        background: rgba(255, 71, 87, 0.2);
        border: 1px solid rgba(255, 71, 87, 0.3);
        color: #ff4757;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .clear-btn:hover {
        background: rgba(255, 71, 87, 0.3);
    }
    
    /* Search History */
    .search-history {
        margin-top: 20px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .history-title {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .history-items {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .history-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .history-item:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    /* Responsive adjustments for new features */
    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
        }
        
        .sort-options {
            flex-wrap: wrap;
        }
        
        .quick-search {
            justify-content: flex-start;
        }
        
        .export-options {
            justify-content: center;
        }
        
        .grid-view {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
        
        .stats-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
  </style>
</head>
<body>

<!-- Mobile Menu Button -->
<div class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">
    <span></span>
    <span></span>
    <span></span>
</div>

<!-- Sidebar Overlay for Mobile -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>

<div class="dashboard">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="toggle-btn" onclick="toggleSidebar()">‚óÄ</div>
        
        <div class="logo">
            <span class="logo-icon">üìö</span>
            <span class="logo-text">Library</span>
        </div>

        <ul class="menu">
            <li>
                <a href="{{ url_for('index') }}">
                    <span class="menu-icon">üè†</span>
                    <span class="menu-text">Home</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('books') }}">
                    <span class="menu-icon">üìñ</span>
                    <span class="menu-text">All Books</span>
                </a>
            </li>
            <li>
                <a class="active" href="{{ url_for('search') }}">
                    <span class="menu-icon">üîç</span>
                    <span class="menu-text">Search</span>
                </a>
            </li>
            
            {% if session.get('user_id') %}
                <li>
                    <a href="{{ url_for('add_book') }}">
                        <span class="menu-icon">‚ûï</span>
                        <span class="menu-text">Add Book</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('library_card') }}">
                        <span class="menu-icon">üí≥</span>
                        <span class="menu-text">Library Card</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('logout') }}">
                        <span class="menu-icon">üö™</span>
                        <span class="menu-text">Logout ({{ session.get('username') }})</span>
                    </a>
                </li>
            {% else %}
                <li>
                    <a href="{{ url_for('login') }}">
                        <span class="menu-icon">üîê</span>
                        <span class="menu-text">Login</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('register') }}">
                        <span class="menu-icon">üìù</span>
                        <span class="menu-text">Register</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">

        {% with msgs = get_flashed_messages(with_categories=true) %}
          {% for cat, msg in msgs %}
            <div class="flash {{ cat }}">{{ msg }}</div>
          {% endfor %}
        {% endwith %}

        <div class="container">
          <h2>Advanced Book Search</h2>

          <!-- Quick Search Buttons -->
          <div class="quick-search">
            <button class="quick-btn" onclick="quickSearch('available')">Available Books</button>
            <button class="quick-btn" onclick="quickSearch('recent')">Recently Added</button>
            <button class="quick-btn" onclick="quickSearch('fiction')">Fiction</button>
            <button class="quick-btn" onclick="quickSearch('popular')">Popular Genres</button>
            <button class="quick-btn" onclick="quickSearch('new')">New Releases</button>
          </div>

          <form method="POST" class="search-form" id="searchForm">
            <div class="form-row">
              <div class="form-group">
                <label for="search_term">Search Term:</label>
                <input type="text" id="search_term" name="search_term" 
                       {% if search_term %}value="{{ search_term }}"{% endif %} 
                       placeholder="Enter title, author, or keyword">
              </div>
              
              <div class="form-group">
                <label for="search_by">Search By:</label>
                <select id="search_by" name="search_by">
                  <option value="title" {% if search_by == 'title' %}selected{% endif %}>Title</option>
                  <option value="author" {% if search_by == 'author' %}selected{% endif %}>Author</option>
                  <option value="genre" {% if search_by == 'genre' %}selected{% endif %}>Genre</option>
                  <option value="year" {% if search_by == 'year' %}selected{% endif %}>Publication Year</option>
                  <option value="isbn" {% if search_by == 'isbn' %}selected{% endif %}>ISBN</option>
                </select>
              </div>
            </div>

            <!-- Advanced Search Toggle -->
            <div class="advanced-toggle">
              <button type="button" class="advanced-toggle-btn" onclick="toggleAdvancedSearch()">
                <span>Advanced Options</span>
                <i>‚ñº</i>
              </button>
            </div>

            <!-- Advanced Search Panel -->
            <div class="advanced-search" id="advancedSearch">
              <div class="filter-row">
                <div class="filter-group">
                  <div class="filter-label">
                    <span>Status Filter:</span>
                  </div>
                  <div class="checkbox-group">
                    <label class="checkbox-item">
                      <input type="checkbox" name="status[]" value="Available" checked> Available
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="status[]" value="Checked Out"> Checked Out
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="status[]" value="Reserved"> Reserved
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="status[]" value="Lost"> Lost
                    </label>
                  </div>
                </div>
                
                <div class="filter-group">
                  <div class="filter-label">
                    <span>Year Range:</span>
                  </div>
                  <div class="form-row" style="gap: 10px; margin: 0;">
                    <input type="number" name="year_from" placeholder="From" min="1000" max="2025" style="flex: 1;">
                    <input type="number" name="year_to" placeholder="To" min="1000" max="2025" style="flex: 1;">
                  </div>
                </div>
              </div>
              
              <div class="clear-filters">
                <button type="button" class="clear-btn" onclick="clearFilters()">Clear All Filters</button>
              </div>
            </div>

            <!-- Sort Options -->
            <div class="sort-options">
              <span class="sort-label">Sort by:</span>
              <select name="sort_by" style="flex: 1; max-width: 200px;">
                <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title (A-Z)</option>
                <option value="title_desc" {% if sort_by == 'title_desc' %}selected{% endif %}>Title (Z-A)</option>
                <option value="author" {% if sort_by == 'author' %}selected{% endif %}>Author (A-Z)</option>
                <option value="year" {% if sort_by == 'year' %}selected{% endif %}>Year (Newest)</option>
                <option value="year_asc" {% if sort_by == 'year_asc' %}selected{% endif %}>Year (Oldest)</option>
                <option value="added" {% if sort_by == 'added' %}selected{% endif %}>Recently Added</option>
              </select>
            </div>
            
            <div class="form-actions">
              <button type="submit" class="btn btn-primary" onclick="showLoading()">Search</button>
              <!-- FIX 2: Added missing onclick handler for reset button -->
              <button type="button" class="btn btn-tertiary" onclick="resetForm()">Reset</button>
            </div>
          </form>

          <!-- Search History -->
          <div class="search-history" id="searchHistory">
            <div class="history-title">
              <span>Recent Searches:</span>
              <button onclick="clearHistory()" style="background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;">Clear</button>
            </div>
            <div class="history-items" id="historyItems">
              <!-- Show Flask search history -->
              {% for item in search_history %}
              <div class="history-item" onclick="useHistory('{{ item.search_term }}', '{{ item.search_by }}')">
                {{ item.search_term }} ({{ item.search_by }})
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Loading Animation -->
          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Searching books...</p>
          </div>

          {% if books %}
          <!-- Stats Panel -->
          <div class="stats-panel">
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value">{{ books|length }}</div>
                <div class="stat-label">Books Found</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ available_count }}</div>
                <div class="stat-label">Available</div>
              </div>
              <div class="stat-item">
                {% set unique_genres = [] %}
                {% for book in books %}
                  {% if book.genre and book.genre not in unique_genres %}
                    {% set _ = unique_genres.append(book.genre) %}
                  {% endif %}
                {% endfor %}
                <div class="stat-value">{{ unique_genres|length }}</div>
                <div class="stat-label">Genres</div>
              </div>
              <div class="stat-item">
                {% set unique_authors = [] %}
                {% for book in books %}
                  {% if book.author and book.author not in unique_authors %}
                    {% set _ = unique_authors.append(book.author) %}
                  {% endif %}
                {% endfor %}
                <div class="stat-value">{{ unique_authors|length }}</div>
                <div class="stat-label">Authors</div>
              </div>
            </div>
          </div>

          <!-- View Toggle -->
          <div class="view-toggle">
            <button class="view-btn active" onclick="setView('table')" title="Table View">
              üìã
            </button>
            <button class="view-btn" onclick="setView('grid')" title="Grid View">
              üüß
            </button>
          </div>

          <h3 class="results-header">Search Results ({{ books|length }} found)</h3>
          
          <!-- Table View -->
          <div class="table-wrap" id="tableView">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Author</th>
                  <th>ISBN</th>
                  <th>Year</th>
                  <th>Genre</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for book in books %}
                <tr>
                  <td>{{ book.id }}</td>
                  <td>{{ book.title }}</td>
                  <td>{{ book.author }}</td>
                  <td>{{ book.isbn or 'N/A' }}</td>
                  <td>{{ book.published_year or 'N/A' }}</td>
                  <td>{{ book.genre or 'N/A' }}</td>
                  <td>
                    <span class="status-badge {% if book.status == 'Available' %}status-available{% else %}status-unavailable{% endif %}">
                      {{ book.status }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" 
                            onclick="viewBookDetails({{ book.id }})">View</button>
                    {% if session.get('user_id') %}
                    <a href="{{ url_for('edit_book', book_id=book.id) }}" 
                       class="btn btn-tertiary" style="padding: 5px 10px; font-size: 12px;">Edit</a>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Grid View -->
          <div class="grid-view" id="gridView">
            {% for book in books %}
            <div class="book-card" onclick="viewBookDetails({{ book.id }})">
              <div class="book-card-title">{{ book.title }}</div>
              <div class="book-card-author">{{ book.author }}</div>
              <div class="book-card-details">
                <span>{{ book.published_year or 'N/A' }}</span>
                <span class="status-badge {% if book.status == 'Available' %}status-available{% else %}status-unavailable{% endif %}" 
                      style="font-size: 10px; padding: 2px 8px;">
                  {{ book.status }}
                </span>
              </div>
            </div>
            {% endfor %}
          </div>

          <!-- Export Options -->
          <div class="export-options">
            <button class="export-btn" onclick="exportResults('csv')">
              üìä Export CSV
            </button>
            <button class="export-btn" onclick="exportResults('pdf')">
              üìÑ Export PDF
            </button>
            <button class="export-btn" onclick="printResults()">
              üñ®Ô∏è Print
            </button>
          </div>

          <!-- Pagination -->
          {% if books|length > 10 %}
          <div class="pagination">
            <button class="page-btn active">1</button>
            <button class="page-btn">2</button>
            <button class="page-btn">3</button>
            <button class="page-btn">4</button>
            <button class="page-btn">5</button>
            <span style="color: rgba(255,255,255,0.5); padding: 8px 15px;">...</span>
          </div>
          {% endif %}
          
          {% elif request.method == 'POST' %}
          <div class="no-results">
            <p>No books found matching your search criteria.</p>
            <p style="margin-top: 10px; font-size: 14px; color: rgba(255,255,255,0.6);">
              Try different keywords or remove some filters.
            </p>
          </div>
          {% endif %}
        </div>

    </main>

</div>

<!-- Book Details Modal -->
<div class="modal-overlay" id="bookModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Book Details</div>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="book-details" id="bookDetails">
      <!-- Book details will be loaded here -->
    </div>
  </div>
</div>

<footer>¬© 2025 Library Management System</footer>

<script>
    // Toggle sidebar for desktop
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.querySelector('.toggle-btn');
        
        sidebar.classList.toggle('collapsed');
        
        if (sidebar.classList.contains('collapsed')) {
            toggleBtn.innerHTML = '‚ñ∂';
        } else {
            toggleBtn.innerHTML = '‚óÄ';
        }
    }

    // Toggle mobile menu
    function toggleMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const menuBtn = document.getElementById('mobileMenuBtn');
        
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
        menuBtn.classList.toggle('active');
    }

    // Close mobile menu
    function closeMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const menuBtn = document.getElementById('mobileMenuBtn');
        
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        menuBtn.classList.remove('active');
    }

    // Toggle Advanced Search
    function toggleAdvancedSearch() {
        const advancedSearch = document.getElementById('advancedSearch');
        const toggleBtn = document.querySelector('.advanced-toggle-btn');
        
        advancedSearch.classList.toggle('show');
        toggleBtn.classList.toggle('active');
    }

    // Set View (Table/Grid)
    function setView(viewType) {
        const tableView = document.getElementById('tableView');
        const gridView = document.getElementById('gridView');
        const viewBtns = document.querySelectorAll('.view-btn');
        
        viewBtns.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if (viewType === 'table') {
            tableView.style.display = 'block';
            gridView.classList.remove('active');
        } else {
            tableView.style.display = 'none';
            gridView.classList.add('active');
        }
    }

    // Show Loading Animation
    function showLoading() {
        document.getElementById('loading').classList.add('active');
        // Auto-hide after 2 seconds (for demo)
        setTimeout(() => {
            document.getElementById('loading').classList.remove('active');
        }, 2000);
    }

    // Reset Form
    function resetForm() {
        document.getElementById('searchForm').reset();
        const advancedSearch = document.getElementById('advancedSearch');
        advancedSearch.classList.remove('show');
        document.querySelector('.advanced-toggle-btn').classList.remove('active');
    }

    // Clear Filters
    function clearFilters() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const inputs = document.querySelectorAll('input[type="number"]');
        
        checkboxes.forEach(cb => cb.checked = false);
        inputs.forEach(input => input.value = '');
    }

    // Quick Search
    function quickSearch(type) {
        const searchTerm = document.getElementById('search_term');
        const searchBy = document.getElementById('search_by');
        
        switch(type) {
            case 'available':
                searchTerm.value = '';
                searchBy.value = 'title';
                // Check Available checkbox
                document.querySelector('input[value="Available"]').checked = true;
                document.querySelector('input[value="Checked Out"]').checked = false;
                document.querySelector('input[value="Reserved"]').checked = false;
                document.querySelector('input[value="Lost"]').checked = false;
                break;
            case 'recent':
                searchTerm.value = '';
                searchBy.value = 'year';
                document.querySelector('select[name="sort_by"]').value = 'added';
                break;
            case 'fiction':
                searchTerm.value = 'Fiction';
                searchBy.value = 'genre';
                break;
            case 'popular':
                searchTerm.value = 'Fantasy';
                searchBy.value = 'genre';
                break;
            case 'new':
                const currentYear = new Date().getFullYear();
                searchTerm.value = currentYear - 5; // Last 5 years
                searchBy.value = 'year';
                break;
        }
        
        document.getElementById('searchForm').submit();
    }

   // View Book Details (Modal) - Using AJAX
function viewBookDetails(bookId) {
    showLoading();
    
    fetch(`/api/book/${bookId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Book not found');
            }
            return response.json();
        })
        .then(book => {
            document.getElementById('modalTitle').textContent = book.title;
            document.getElementById('bookDetails').innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Title:</span>
                    <span class="detail-value">${book.title}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Author:</span>
                    <span class="detail-value">${book.author}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">ISBN:</span>
                    <span class="detail-value">${book.isbn || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Year:</span>
                    <span class="detail-value">${book.published_year || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Genre:</span>
                    <span class="detail-value">${book.genre || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">
                        <span class="status-badge ${book.status === 'Available' ? 'status-available' : 'status-unavailable'}">
                            ${book.status}
                        </span>
                    </span>
                </div>
                ${book.description ? `
                <div class="detail-row" style="flex-direction: column; margin-top: 15px;">
                    <span class="detail-label">Description:</span>
                    <span class="detail-value" style="color: rgba(255,255,255,0.8); font-weight: normal; line-height: 1.5;">
                        ${book.description}
                    </span>
                </div>` : ''}
                ${book.cover && book.cover !== 'default.jpg' ? `
                <div class="detail-row">
                    <span class="detail-label">Cover Image:</span>
                    <span class="detail-value">${book.cover}</span>
                </div>` : ''}
                ${book.created_date ? `
                <div class="detail-row">
                    <span class="detail-label">Added On:</span>
                    <span class="detail-value">${new Date(book.created_date).toLocaleDateString()}</span>
                </div>` : ''}
                <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    ${window.location.href.includes('/search') && {{ session.get('user_id')|tojson|safe }} ? `
                    <a href="/edit_book/${book.id}" class="btn btn-primary" style="padding: 8px 15px;">Edit Book</a>
                    ` : ''}
                    <button class="btn btn-tertiary" onclick="closeModal()" style="padding: 8px 15px;">Close</button>
                </div>
            `;
            
            document.getElementById('bookModal').classList.add('active');
            document.getElementById('loading').classList.remove('active');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load book details: ' + error.message);
            document.getElementById('loading').classList.remove('active');
        });
}

    // Close Modal
    function closeModal() {
        document.getElementById('bookModal').classList.remove('active');
    }

    // Export Results
    function exportResults(format) {
        if (format === 'csv') {
            window.location.href = '/export/search_results';
        } else {
            alert(`Exporting results as ${format.toUpperCase()}...\n\nThis feature would generate and download a ${format} file with all search results.`);
        }
    }

    // Print Results
    function printResults() {
        window.print();
    }

    // Search History Management
    function addToHistory(searchTerm, searchBy) {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        const newEntry = { term: searchTerm, by: searchBy, date: new Date().toLocaleString() };
        
        // Remove if already exists
        const existingIndex = history.findIndex(h => h.term === searchTerm && h.by === searchBy);
        if (existingIndex > -1) {
            history.splice(existingIndex, 1);
        }
        
        // Add to beginning and keep only last 5
        history.unshift(newEntry);
        if (history.length > 5) history.pop();
        
        localStorage.setItem('searchHistory', JSON.stringify(history));
        updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
        const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        const historyItems = document.getElementById('historyItems');
        
        // Add local storage history to existing Flask history
        let html = '';
        history.forEach(item => {
            // FIX 3: Escape quotes in search terms
            const safeTerm = item.term.replace(/'/g, "\\'").replace(/"/g, '\\"');
            const safeBy = item.by.replace(/'/g, "\\'").replace(/"/g, '\\"');
            html += `<div class="history-item" onclick="useHistory('${safeTerm}', '${safeBy}')">
                ${item.term} (${item.by})
            </div>`;
        });
        
        // Don't overwrite Flask history if it exists
        if (historyItems.children.length === 0) {
            historyItems.innerHTML = html;
        }
    }

    function useHistory(term, by) {
        document.getElementById('search_term').value = term;
        document.getElementById('search_by').value = by;
        document.getElementById('searchForm').submit();
    }

    function clearHistory() {
        localStorage.removeItem('searchHistory');
        updateHistoryDisplay();
    }

    // Close modal when clicking outside
    document.getElementById('bookModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateHistoryDisplay();
        
        // Add current search to history if there are results
        const searchTerm = document.getElementById('search_term').value;
        const searchBy = document.getElementById('search_by').value;
        
        if (searchTerm) {
            addToHistory(searchTerm, searchBy);
        }
        
        // Close mobile menu when clicking links
        document.querySelectorAll('.menu a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    closeMobileMenu();
                }
            });
        });
        
        // Auto-show advanced search if filters are set
        const yearFrom = document.querySelector('input[name="year_from"]');
        const yearTo = document.querySelector('input[name="year_to"]');
        if ((yearFrom && yearFrom.value) || (yearTo && yearTo.value)) {
            toggleAdvancedSearch();
        }
    });

    // Handle window resize
    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            menuBtn.classList.remove('active');
        }
    });
</script>

</body>
</html>